name: Daily IPO Status Check - 5:00 AM NPT

on:
  schedule:
    # Run at 5:00 AM NPT every day (23:15 UTC previous day)
    - cron: '15 23 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check even if not scheduled'
        required: false
        default: false
        type: boolean

jobs:
  check-ipo-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Check IPO Status APIs
      id: check-status
      run: |
        python utils/ipo_status_checker.py check-ipo-status
    
    - name: Read Results File
      id: read-results
      run: |
        if [ -f results.json ]; then
          RESULTS=$(cat results.json)
          echo "results=$RESULTS" >> $GITHUB_OUTPUT
        else
          echo "results=[]" >> $GITHUB_OUTPUT
        fi
    
    - name: Set Environment Variable
      run: |
        # Extract values from the check-status output
        APPLY_FOR_TODAY=$(python utils/ipo_status_checker.py check-ipo-status | grep "apply_for_today=" | cut -d'=' -f2)
        ANY_OPEN=$(python utils/ipo_status_checker.py check-ipo-status | grep "any_open=" | cut -d'=' -f2)
        
        echo "APPLY_FOR_TODAY=$APPLY_FOR_TODAY" >> $GITHUB_ENV
        echo "ANY_OPEN=$ANY_OPEN" >> $GITHUB_ENV
    
    - name: Display Results
      run: |
        echo "üéØ Final Results:"
        echo "‚Ä¢ Apply for Today: ${{ env.APPLY_FOR_TODAY }}"
        echo "‚Ä¢ Any Open Status: ${{ env.ANY_OPEN }}"
        echo "‚Ä¢ Detailed Results: ${{ steps.check-status.outputs.results }}"
        
        if [ "${{ env.APPLY_FOR_TODAY }}" = "true" ]; then
          echo "‚úÖ Setting apply_for_today to true - IPOs/FPOs/Right-Shares are available!"
        else
          echo "‚ÑπÔ∏è Setting apply_for_today to false - No open IPOs/FPOs/Right-Shares found"
        fi
    
    - name: Send Telegram Notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        APPLY_FOR_TODAY: ${{ env.APPLY_FOR_TODAY }}
        ANY_OPEN: ${{ env.ANY_OPEN }}
      run: |
        python utils/ipo_status_checker.py send-notification 