name: Daily IPO Status Check - 5:00 AM NPT

on:
  schedule:
    # Run at 5:00 AM NPT every day (23:15 UTC previous day)
    - cron: '15 23 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check even if not scheduled'
        required: false
        default: false
        type: boolean

jobs:
  check-ipo-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Check IPO Status APIs
      id: check-status
      run: |
        python check_ipo_status.py
    
    - name: Read Results File
      id: read-results
      run: |
        if [ -f results.json ]; then
          RESULTS=$(cat results.json)
          echo "::set-output name=results::$RESULTS"
        else
          echo "::set-output name=results::[]"
        fi
    
    - name: Set Environment Variable
      run: |
        echo "APPLY_FOR_TODAY=${{ steps.check-status.outputs.apply_for_today }}" >> $GITHUB_ENV
        echo "ANY_OPEN=${{ steps.check-status.outputs.any_open }}" >> $GITHUB_ENV
    
    - name: Display Results
      run: |
        echo "üéØ Final Results:"
        echo "‚Ä¢ Apply for Today: ${{ env.APPLY_FOR_TODAY }}"
        echo "‚Ä¢ Any Open Status: ${{ env.ANY_OPEN }}"
        echo "‚Ä¢ Detailed Results: ${{ steps.check-status.outputs.results }}"
        
        if [ "${{ env.APPLY_FOR_TODAY }}" = "true" ]; then
          echo "‚úÖ Setting apply_for_today to true - IPOs/FPOs/Right-Shares are available!"
        else
          echo "‚ÑπÔ∏è Setting apply_for_today to false - No open IPOs/FPOs/Right-Shares found"
        fi
    
    - name: Send Telegram Notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python -c "
        import requests
        import os
        import json
        from datetime import datetime
        
        telegram_token = os.getenv('TELEGRAM_BOT_TOKEN')
        telegram_chat_id = os.getenv('TELEGRAM_CHAT_ID')
        apply_for_today = '${{ env.APPLY_FOR_TODAY }}'
        any_open = '${{ env.ANY_OPEN }}'
        results = '${{ steps.read-results.outputs.results }}'
        
        if not telegram_token or not telegram_chat_id:
            print('‚ùå Telegram credentials not set')
            exit(0)
        
        try:
            # Parse results
            results_data = json.loads(results) if results else []
            
            # Create message
            message = f'üìä Daily IPO Status Check - {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}\\n\\n'
            
            if apply_for_today == 'true':
                message += '‚úÖ Apply for Today: TRUE\\n'
                message += 'üéØ Open IPOs/FPOs/Right-Shares found!\\n\\n'
            else:
                message += '‚ÑπÔ∏è Apply for Today: FALSE\\n'
                message += 'üìã No open IPOs/FPOs/Right-Shares found\\n\\n'
            
            message += 'üìã API Status:\\n'
            for result in results_data:
                status_emoji = '‚úÖ' if 'Open' in result['status'] else '‚ùå'
                message += f'{status_emoji} {result[\"api\"]}: {result[\"status\"]}\\n'
            
            # Send to Telegram
            url = f'https://api.telegram.org/bot{telegram_token}/sendMessage'
            payload = {
                'chat_id': telegram_chat_id,
                'text': message,
                'parse_mode': 'Markdown'
            }
            
            response = requests.post(url, json=payload, timeout=10)
            
            if response.status_code == 200:
                print('‚úÖ Telegram notification sent successfully')
            else:
                print(f'‚ùå Failed to send Telegram notification: {response.status_code}')
                
        except Exception as e:
            print(f'‚ùå Error sending Telegram notification: {str(e)}')
        " 