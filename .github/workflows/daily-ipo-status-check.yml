name: Daily IPO Status Check - 5:00 AM NPT

on:
  schedule:
    # Run at 5:00 AM NPT every day (23:15 UTC previous day)
    - cron: '15 23 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force check even if not scheduled'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  actions: write

jobs:
  check-ipo-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Check IPO Status APIs
      id: check-status
      run: |
        python utils/ipo_status_checker.py check-ipo-status
    
    - name: Read Results File
      id: read-results
      run: |
        if [ -f results.json ]; then
          RESULTS=$(cat results.json)
          echo "results=$RESULTS" >> $GITHUB_OUTPUT
        else
          echo "results=[]" >> $GITHUB_OUTPUT
        fi
    
    - name: Set Environment Variable
      run: |
        # Extract values from the check-status output
        APPLY_FOR_TODAY=$(python utils/ipo_status_checker.py check-ipo-status | grep "apply_for_today=" | cut -d'=' -f2)
        
        echo "APPLY_FOR_TODAY=$APPLY_FOR_TODAY" >> $GITHUB_ENV
        
        echo "‚úÖ Environment variables set:"
        echo "‚Ä¢ APPLY_FOR_TODAY = $APPLY_FOR_TODAY"
    
    - name: Update Repository Variables
      env:
        GITHUB_TOKEN: ${{ github.token }}
        APPLY_FOR_TODAY: ${{ env.APPLY_FOR_TODAY }}
      run: |
        # Update repository variables using GitHub API
        python utils/update_repo_variables.py "$APPLY_FOR_TODAY"
    
    - name: Display Results
      env:
        APPLY_FOR_TODAY: ${{ env.APPLY_FOR_TODAY }}
        DETAILED_RESULTS: ${{ steps.read-results.outputs.results }}
      run: |
        echo "üéØ Final Results:"
        echo "‚Ä¢ Apply for Today: $APPLY_FOR_TODAY"
        
        if [ "$APPLY_FOR_TODAY" = "true" ]; then
          echo "‚úÖ Setting apply_for_today to true - IPOs/FPOs/Right-Shares are available!"
        else
          echo "‚ÑπÔ∏è Setting apply_for_today to false - No open IPOs/FPOs/Right-Shares found"
        fi
    
    - name: Debug Repository Variables
      env:
        APPLY_FOR_TODAY: ${{ env.APPLY_FOR_TODAY }}
        REPO_APPLY_FOR_TODAY: ${{ vars.APPLY_FOR_TODAY }}
      run: |
        echo "üîç Debugging Repository Variables:"
        echo "‚Ä¢ Repository APPLY_FOR_TODAY: $REPO_APPLY_FOR_TODAY"
        echo "‚Ä¢ Workflow APPLY_FOR_TODAY: $APPLY_FOR_TODAY"
        
        echo ""
        echo "üìã Summary:"
        echo "‚Ä¢ Workflow variables (temporary): Set during this run"
        echo "‚Ä¢ Repository variables (permanent): Need manual update"
        echo ""
        echo "üí° To update repository variables manually:"
        echo "1. Go to Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables"
        echo "2. Update APPLY_FOR_TODAY to: $APPLY_FOR_TODAY"
    
    - name: Show Current Status
      env:
        APPLY_FOR_TODAY: ${{ env.APPLY_FOR_TODAY }}
      run: |
        echo "üîÑ Current IPO Status:"
        echo "‚Ä¢ APPLY_FOR_TODAY: $APPLY_FOR_TODAY"
        
        echo ""
        echo "üìã Manual Update Required:"
        echo "To update repository variables, go to:"
        echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables"
        echo ""
        echo "Set these values:"
        echo "‚Ä¢ APPLY_FOR_TODAY = $APPLY_FOR_TODAY"
    
    - name: Send Telegram Notification
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        APPLY_FOR_TODAY: ${{ env.APPLY_FOR_TODAY }}
      run: |
        python utils/ipo_status_checker.py send-notification 